generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================
// MODELO NEGOCIO (Multi-Tenant)
// ==========================

model Negocio {
  id                       Int                      @id @default(autoincrement())
  nombre                   String
  descripcion              String?
  activo                   Boolean                  @default(true)
  configuracion            Json?                    // Configuración específica del negocio
  createdAt                DateTime                 @default(now())
  updatedAt                DateTime                 @updatedAt

  // Relaciones
  usuarios                 Usuario[]
  personas                 Persona[]
  valorHoras               ValorHora[]
  registroHoras            RegistroHoras[]
  categorias               Categoria[]
  campanas                 Campana[]
  transacciones            Transaccion[]
  distribucionUtilidades   DistribucionUtilidades[]
  vsCarpetas               VSCarpeta[]
  vsGrupos                 VSGrupo[]
  vsConfiguraciones        VSConfiguracion[]
  hourDebts                HourDebt[]

  @@map("negocios")
}

model Rol {
  id          Int         @id @default(autoincrement())
  nombreRol   String      @unique
  importancia Int         @default(0)
  descripcion String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  personas    Persona[]
  valorHoras  ValorHora[]
  usuarios    Usuario[]   @relation("UsuarioRolNegocio") // Nueva relación con Usuario

  @@map("roles")
}

model Persona {
  id                  Int                   @id @default(autoincrement())
  negocioId           Int
  nombre              String
  rolId               Int
  usuarioId           Int?
  horasTotales        Int                   @default(0)
  aportesTotales      Float                 @default(0)
  valorHora           Float                 @default(0)
  inversionHoras      Float                 @default(0)
  inversionTotal      Float                 @default(0)
  participacionPorc   Float                 @default(0)
  notas               String?
  activo              Boolean               @default(true)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  email               String?
  distribucionDetalle DistribucionDetalle[]
  negocio             Negocio               @relation(fields: [negocioId], references: [id])
  rol                 Rol                   @relation(fields: [rolId], references: [id])
  registroHoras       RegistroHoras[]
  transacciones       Transaccion[]
  valorHoras          ValorHora[]
  usuario             Usuario?              @relation(fields: [usuarioId], references: [id])

  @@unique([negocioId, nombre])
  @@index([negocioId])
  @@map("personas")
}

model ValorHora {
  id          Int       @id @default(autoincrement())
  negocioId   Int
  personaId   Int       // Deprecado - usar usuarioId
  usuarioId   Int?      // Nueva FK a Usuario
  rolId       Int
  valor       Float
  notas       String?
  fechaInicio DateTime  @default(now())
  fechaFin    DateTime?
  activo      Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  negocio     Negocio   @relation(fields: [negocioId], references: [id])
  rol         Rol       @relation(fields: [rolId], references: [id])
  persona     Persona   @relation(fields: [personaId], references: [id])
  usuario     Usuario?  @relation("ValorHoraUsuario", fields: [usuarioId], references: [id], onDelete: Cascade)

  @@index([negocioId])
  @@index([usuarioId])
  @@map("valor_horas")
}

model RegistroHoras {
  id             Int       @id @default(autoincrement())
  negocioId      Int
  personaId      Int       // Deprecado - usar usuarioId
  usuarioId      Int?      // Nueva FK a Usuario
  campanaId      Int?
  fecha          DateTime
  horas          Float
  descripcion    String?
  aprobado       Boolean   @default(false)
  aprobadoPor    Int?      // ID del usuario que aprobó
  fechaAprobacion DateTime? // Cuándo fue aprobado
  rechazado      Boolean   @default(false)
  motivoRechazo  String?
  origen         String    @default("MANUAL") // MANUAL o TIMER
  timerInicio    DateTime? // Para registros desde timer
  timerFin       DateTime? // Para registros desde timer
  estado         String?   // RUNNING, PAUSADO, COMPLETADO (solo para TIMER)

  // Campos para auditoría y edición de tiempos
  timerInicioOriginal DateTime? // Guarda inicio real antes de edición
  horasOriginales     Float?    // Horas calculadas antes de edición manual
  editadoPor          Int?      // ID del usuario que editó
  fechaEdicion        DateTime? // Cuándo se editó por última vez

  // Soft delete
  deletedAt           DateTime? // Cuándo fue eliminado
  deletedBy           Int?      // ID del usuario que eliminó

  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  negocio        Negocio   @relation(fields: [negocioId], references: [id])
  campana        Campana?  @relation(fields: [campanaId], references: [id])
  persona        Persona   @relation(fields: [personaId], references: [id])
  usuario        Usuario?  @relation("RegistroHorasUsuario", fields: [usuarioId], references: [id], onDelete: Cascade)
  debtDeductions DebtDeduction[]

  @@index([negocioId])
  @@index([negocioId, personaId])
  @@index([negocioId, usuarioId])
  @@index([negocioId, aprobado])
  @@index([negocioId, estado]) // Nuevo índice para buscar timers activos
  @@index([personaId, fecha, aprobado]) // Índice para queries de deuda
  @@map("registro_horas")
}

model Categoria {
  id            Int           @id @default(autoincrement())
  negocioId     Int
  nombre        String
  usuarioId     Int?
  descripcion   String?
  color         String?
  activo        Boolean       @default(true)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  negocio       Negocio       @relation(fields: [negocioId], references: [id])
  transacciones Transaccion[]
  vsGrupoCategorias VSGrupoCategoria[]
  usuario       Usuario?      @relation(fields: [usuarioId], references: [id])

  @@unique([negocioId, nombre])
  @@index([negocioId])
  @@map("categorias")
}

model Campana {
  id            Int             @id @default(autoincrement())
  negocioId     Int
  nombre        String
  usuarioId     Int?
  descripcion   String?
  fechaInicio   DateTime
  fechaFin      DateTime?
  presupuesto   Float?
  ingresoTotal  Float           @default(0)
  gastoTotal    Float           @default(0)
  utilidad      Float           @default(0)
  activo        Boolean         @default(true)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  negocio       Negocio         @relation(fields: [negocioId], references: [id])
  registroHoras RegistroHoras[]
  transacciones Transaccion[]
  usuario       Usuario?        @relation(fields: [usuarioId], references: [id])

  @@unique([negocioId, nombre])
  @@index([negocioId])
  @@map("campanas")
}

model TipoTransaccion {
  id            Int           @id @default(autoincrement())
  nombre        String        @unique
  descripcion   String?
  activo        Boolean       @default(true)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  transacciones Transaccion[]

  @@map("tipos_transaccion")
}

model Transaccion {
  id          Int             @id @default(autoincrement())
  negocioId   Int
  tipoId      Int
  usuarioId   Int?
  monto       Float
  concepto    String
  fecha       DateTime
  categoriaId Int?
  personaId   Int?
  campanaId   Int?
  moneda      String          @default("COP")
  notas       String?
  comprobante String?
  aprobado    Boolean         @default(false)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  negocio     Negocio         @relation(fields: [negocioId], references: [id])
  campana     Campana?        @relation(fields: [campanaId], references: [id])
  persona     Persona?        @relation(fields: [personaId], references: [id])
  tipo        TipoTransaccion @relation(fields: [tipoId], references: [id])
  categoria   Categoria?      @relation(fields: [categoriaId], references: [id])
  usuario     Usuario?        @relation(fields: [usuarioId], references: [id])

  @@index([negocioId])
  @@index([negocioId, fecha])
  @@map("transacciones")
}

model DistribucionUtilidades {
  id            Int                   @id @default(autoincrement())
  negocioId     Int
  periodo       String
  fecha         DateTime              @default(now())
  utilidadTotal Float
  estado        String                @default("Pendiente")
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
  negocio       Negocio               @relation(fields: [negocioId], references: [id])
  detalles      DistribucionDetalle[]

  @@index([negocioId])
  @@map("distribucion_utilidades")
}

model DistribucionDetalle {
  id                      Int                    @id @default(autoincrement())
  distribucionId          Int
  personaId               Int                    // Deprecado - usar usuarioId
  usuarioId               Int?                   // Nueva FK a Usuario
  porcentajeParticipacion Float
  montoDistribuido        Float
  createdAt               DateTime               @default(now())
  updatedAt               DateTime               @updatedAt
  persona                 Persona                @relation(fields: [personaId], references: [id])
  usuario                 Usuario?               @relation("DistribucionDetalleUsuario", fields: [usuarioId], references: [id], onDelete: Cascade)
  distribucion            DistribucionUtilidades @relation(fields: [distribucionId], references: [id])

  @@index([usuarioId])
  @@map("distribucion_detalles")
}

model Usuario {
  id        Int      @id @default(autoincrement())
  negocioId Int      // Usuario pertenece a un negocio
  email     String   @unique
  password  String
  nombre    String
  rol       String   @default("USER") // ADMIN_NEGOCIO, USER, EMPLEADO
  activo    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Campos migrados de Persona (para consolidación)
  rolId              Int?    // FK opcional a Rol (rol de negocio)
  participacionPorc  Float   @default(0) // % de participación en utilidades
  horasTotales       Int     @default(0) // Total horas trabajadas
  aportesTotales     Float   @default(0) // Total aportes económicos
  valorHora          Float   @default(0) // Valor por hora actual
  inversionHoras     Float   @default(0) // Inversión por horas
  inversionTotal     Float   @default(0) // Inversión total
  notas              String? // Notas adicionales

  // Campos para sistema SMTP (activación y recuperación)
  emailVerified        Boolean   @default(false)  // Si el email fue verificado
  activationToken      String?                    // Token de activación de cuenta
  resetPasswordToken   String?                    // Token de recuperación de contraseña
  resetPasswordExpires DateTime?                  // Expiración del token de reset

  // Relación con negocio
  negocio       Negocio   @relation(fields: [negocioId], references: [id])
  rolNegocio    Rol?      @relation("UsuarioRolNegocio", fields: [rolId], references: [id])

  // Relaciones inversas (propiedad)
  personas      Persona[]
  categorias    Categoria[]
  campanas      Campana[]
  transacciones Transaccion[]

  // Relaciones migradas de Persona
  registroHoras       RegistroHoras[]       @relation("RegistroHorasUsuario")
  valorHoras          ValorHora[]           @relation("ValorHoraUsuario")
  distribucionDetalle DistribucionDetalle[] @relation("DistribucionDetalleUsuario")

  // Sistema de Deuda de Horas
  hourDebts          HourDebt[]        @relation("HourDebtUsuario")
  createdDebts       HourDebt[]        @relation("HourDebtCreator")
  editedDebts        HourDebt[]        @relation("HourDebtEditor")
  deletedDebts       HourDebt[]        @relation("HourDebtDeleter")
  auditLogs          HourDebtAuditLog[]

  // Roles de plataforma (opcional)
  rolesSistema  UsuarioRol[]

  @@index([negocioId])
  @@index([negocioId, rol])
  @@index([rolId])
  @@index([activationToken])
  @@index([resetPasswordToken])
  @@map("usuarios")
}

// Modelos para VS Categorías - Sistema Avanzado
model VSCarpeta {
  id          Int       @id @default(autoincrement())
  negocioId   Int
  nombre      String
  color       String
  visible     Boolean   @default(true)
  orden       Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  negocio     Negocio   @relation(fields: [negocioId], references: [id])
  grupos      VSGrupo[]

  @@index([negocioId])
  @@map("vs_carpetas")
}

model VSGrupo {
  id          Int       @id @default(autoincrement())
  negocioId   Int
  nombre      String
  color       String
  visible     Boolean   @default(true)
  orden       Int       @default(0)
  carpetaId   Int?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  negocio     Negocio   @relation(fields: [negocioId], references: [id])
  carpeta     VSCarpeta? @relation(fields: [carpetaId], references: [id])
  categorias  VSGrupoCategoria[]

  @@index([negocioId])
  @@map("vs_grupos")
}

model VSGrupoCategoria {
  id          Int       @id @default(autoincrement())
  grupoId     Int
  categoriaId Int
  createdAt   DateTime  @default(now())
  grupo       VSGrupo   @relation(fields: [grupoId], references: [id])
  categoria   Categoria @relation(fields: [categoriaId], references: [id])

  @@unique([grupoId, categoriaId])
  @@map("vs_grupo_categorias")
}

model VSConfiguracion {
  id                    Int      @id @default(autoincrement())
  negocioId             Int
  nombre                String
  configuracion         Json     // Almacena toda la configuración como JSON
  activo                Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  negocio               Negocio  @relation(fields: [negocioId], references: [id])

  @@unique([negocioId, nombre])
  @@index([negocioId])
  @@map("vs_configuraciones")
}

// ==========================
// Roles de plataforma (Auth)
// ==========================

model RolSistema {
  id          Int          @id @default(autoincrement())
  nombre      String       @unique
  descripcion String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  usuarios    UsuarioRol[]

  @@map("roles_sistema")
}

model UsuarioRol {
  usuarioId    Int
  rolSistemaId Int
  createdAt    DateTime @default(now())
  usuario      Usuario   @relation(fields: [usuarioId], references: [id])
  rolSistema   RolSistema @relation(fields: [rolSistemaId], references: [id])

  @@id([usuarioId, rolSistemaId])
  @@map("usuarios_roles")
}

// ==========================
// Sistema de Deuda de Horas
// ==========================

enum DebtStatus {
  ACTIVE
  FULLY_PAID
  CANCELLED
}

enum DebtDeletionReason {
  RECORD_REJECTED
  RECORD_DELETED
  HOURS_EDITED
  ADMIN_CORRECTION
}

enum AuditAction {
  CREATE
  UPDATE
  CANCEL
  DELETE
  REACTIVATE
}

enum RecordSource {
  MANUAL
  TIMER
}

enum TimerStatus {
  RUNNING
  PAUSED
  STOPPED
}

model HourDebt {
  id                Int       @id @default(autoincrement())
  negocioId         Int       @map("negocio_id")
  usuarioId         Int       @map("usuario_id")

  date              DateTime  @db.Date
  minutesOwed       Int       @map("minutes_owed")
  remainingMinutes  Int       @map("remaining_minutes")
  reason            String?
  status            DebtStatus @default(ACTIVE)

  createdById       Int       @map("created_by_id")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  editedById        Int?      @map("edited_by_id")
  editedAt          DateTime? @map("edited_at")
  deletedById       Int?      @map("deleted_by_id")
  deletedAt         DateTime? @map("deleted_at")

  negocio           Negocio             @relation(fields: [negocioId], references: [id])
  usuario           Usuario             @relation("HourDebtUsuario", fields: [usuarioId], references: [id])
  createdBy         Usuario             @relation("HourDebtCreator", fields: [createdById], references: [id])
  editedBy          Usuario?            @relation("HourDebtEditor", fields: [editedById], references: [id])
  deletedBy         Usuario?            @relation("HourDebtDeleter", fields: [deletedById], references: [id])
  deductions        DebtDeduction[]
  auditLogs         HourDebtAuditLog[]

  @@index([negocioId])
  @@index([negocioId, usuarioId])
  @@index([negocioId, status])
  @@index([usuarioId, date])
  @@map("hour_debts")
}

model DebtDeduction {
  id                   Int             @id @default(autoincrement())
  debtId               Int             @map("debt_id")
  registroHorasId      Int             @map("registro_horas_id")

  minutesDeducted      Int             @map("minutes_deducted")
  excessMinutes        Int             @default(0) @map("excess_minutes")

  deductedAt           DateTime        @default(now()) @map("deducted_at")

  deletedAt            DateTime?       @map("deleted_at")
  deletedReason        DebtDeletionReason? @map("deleted_reason")

  debt                 HourDebt        @relation(fields: [debtId], references: [id])
  registroHoras        RegistroHoras   @relation(fields: [registroHorasId], references: [id], onDelete: Restrict)

  @@unique([registroHorasId, debtId])
  @@index([debtId])
  @@index([registroHorasId])
  @@index([deletedAt])
  @@map("debt_deductions")
}

model HourDebtAuditLog {
  id              Int       @id @default(autoincrement())
  debtId          Int       @map("debt_id")
  action          AuditAction

  beforeState     Json?     @map("before_state")
  afterState      Json      @map("after_state")
  changedFields   String[]  @map("changed_fields")
  adminReason     String?   @map("admin_reason")

  performedBy     Int       @map("performed_by")
  performedAt     DateTime  @default(now()) @map("performed_at")
  ipAddress       String?   @map("ip_address")
  userAgent       String?   @map("user_agent")

  debt            HourDebt  @relation(fields: [debtId], references: [id])
  performedByUser Usuario   @relation(fields: [performedBy], references: [id])

  @@index([debtId])
  @@index([performedAt])
  @@index([action])
  @@map("hour_debt_audit_log")
}
