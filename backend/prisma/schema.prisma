generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================
// MODELO NEGOCIO (Multi-Tenant)
// ==========================

model Negocio {
  id                       Int                      @id @default(autoincrement())
  nombre                   String
  descripcion              String?
  activo                   Boolean                  @default(true)
  configuracion            Json?                    // ConfiguraciÃ³n especÃ­fica del negocio
  createdAt                DateTime                 @default(now())
  updatedAt                DateTime                 @updatedAt

  // Relaciones
  usuarios                 Usuario[]
  valorHoras               ValorHora[]
  registroHoras            RegistroHoras[]
  categorias               Categoria[]
  campanas                 Campana[]
  transacciones            Transaccion[]
  distribucionUtilidades   DistribucionUtilidades[]
  vsCarpetas               VSCarpeta[]
  vsGrupos                 VSGrupo[]
  vsConfiguraciones        VSConfiguracion[]
  hourDebts                HourDebt[]
  bugReports               BugReport[]

  // Sistema de seguridad
  securityRoles            SecurityRole[]
  securityAuditLogs        SecurityAuditLog[]
  securitySettings         SecuritySettings?

  @@map("negocios")
}

model Rol {
  id          Int         @id @default(autoincrement())
  nombreRol   String      @unique
  importancia Int         @default(0)
  descripcion String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  valorHoras  ValorHora[]
  usuarios    Usuario[]   @relation("UsuarioRolNegocio")

  @@map("roles")
}

model ValorHora {
  id          Int       @id @default(autoincrement())
  negocioId   Int
  usuarioId   Int
  rolId       Int
  valor       Float
  notas       String?
  fechaInicio DateTime  @default(now())
  fechaFin    DateTime?
  activo      Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  negocio     Negocio   @relation(fields: [negocioId], references: [id])
  rol         Rol       @relation(fields: [rolId], references: [id])
  usuario     Usuario   @relation("ValorHoraUsuario", fields: [usuarioId], references: [id], onDelete: Cascade)

  @@index([negocioId])
  @@index([usuarioId])
  @@map("valor_horas")
}

model RegistroHoras {
  id             Int       @id @default(autoincrement())
  negocioId      Int
  usuarioId      Int
  campanaId      Int?
  fecha          DateTime
  horas          Float
  descripcion    String?
  aprobado       Boolean   @default(false)
  aprobadoPor    Int?      // ID del usuario que aprobÃ³
  fechaAprobacion DateTime? // CuÃ¡ndo fue aprobado
  rechazado      Boolean   @default(false)
  motivoRechazo  String?
  origen         String    @default("MANUAL") // MANUAL o TIMER
  timerInicio    DateTime? // Para registros desde timer
  timerFin       DateTime? // Para registros desde timer
  estado         String?   // RUNNING, PAUSADO, COMPLETADO (solo para TIMER)

  // Campos para auditorÃ­a y ediciÃ³n de tiempos
  timerInicioOriginal DateTime? // Guarda inicio real antes de ediciÃ³n
  horasOriginales     Float?    // Horas calculadas antes de ediciÃ³n manual
  editadoPor          Int?      // ID del usuario que editÃ³
  fechaEdicion        DateTime? // CuÃ¡ndo se editÃ³ por Ãºltima vez

  // Soft delete
  deletedAt           DateTime? // CuÃ¡ndo fue eliminado
  deletedBy           Int?      // ID del usuario que eliminÃ³

  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  negocio        Negocio   @relation(fields: [negocioId], references: [id])
  campana        Campana?  @relation(fields: [campanaId], references: [id])
  usuario        Usuario   @relation("RegistroHorasUsuario", fields: [usuarioId], references: [id], onDelete: Cascade)
  debtDeductions DebtDeduction[]

  @@index([negocioId])
  @@index([negocioId, usuarioId])
  @@index([negocioId, aprobado])
  @@index([negocioId, estado])
  @@index([usuarioId, fecha, aprobado])
  @@map("registro_horas")
}

model Categoria {
  id            Int           @id @default(autoincrement())
  negocioId     Int
  nombre        String
  usuarioId     Int?
  descripcion   String?
  color         String?
  activo        Boolean       @default(true)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  negocio       Negocio       @relation(fields: [negocioId], references: [id])
  transacciones Transaccion[]
  vsGrupoCategorias VSGrupoCategoria[]
  usuario       Usuario?      @relation(fields: [usuarioId], references: [id])

  @@unique([negocioId, nombre])
  @@index([negocioId])
  @@map("categorias")
}

model Campana {
  id            Int             @id @default(autoincrement())
  negocioId     Int
  nombre        String
  usuarioId     Int?
  descripcion   String?
  fechaInicio   DateTime
  fechaFin      DateTime?
  presupuesto   Float?
  ingresoTotal  Float           @default(0)
  gastoTotal    Float           @default(0)
  utilidad      Float           @default(0)
  activo        Boolean         @default(true)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  negocio       Negocio         @relation(fields: [negocioId], references: [id])
  registroHoras RegistroHoras[]
  transacciones Transaccion[]
  usuario       Usuario?        @relation(fields: [usuarioId], references: [id])

  @@unique([negocioId, nombre])
  @@index([negocioId])
  @@map("campanas")
}

model TipoTransaccion {
  id            Int           @id @default(autoincrement())
  nombre        String        @unique
  descripcion   String?
  activo        Boolean       @default(true)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  transacciones Transaccion[]

  @@map("tipos_transaccion")
}

model Transaccion {
  id          Int             @id @default(autoincrement())
  negocioId   Int
  tipoId      Int
  usuarioId   Int?
  monto       Float
  concepto    String
  fecha       DateTime
  categoriaId Int?
  campanaId   Int?
  moneda      String          @default("COP")
  notas       String?
  comprobante String?
  aprobado    Boolean         @default(false)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  negocio     Negocio         @relation(fields: [negocioId], references: [id])
  campana     Campana?        @relation(fields: [campanaId], references: [id])
  tipo        TipoTransaccion @relation(fields: [tipoId], references: [id])
  categoria   Categoria?      @relation(fields: [categoriaId], references: [id])
  usuario     Usuario?        @relation(fields: [usuarioId], references: [id])

  @@index([negocioId])
  @@index([negocioId, fecha])
  @@map("transacciones")
}

model DistribucionUtilidades {
  id            Int                   @id @default(autoincrement())
  negocioId     Int
  periodo       String
  fecha         DateTime              @default(now())
  utilidadTotal Float
  estado        String                @default("Pendiente")
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
  negocio       Negocio               @relation(fields: [negocioId], references: [id])
  detalles      DistribucionDetalle[]

  @@index([negocioId])
  @@map("distribucion_utilidades")
}

model DistribucionDetalle {
  id                      Int                    @id @default(autoincrement())
  distribucionId          Int
  usuarioId               Int
  porcentajeParticipacion Float
  montoDistribuido        Float
  createdAt               DateTime               @default(now())
  updatedAt               DateTime               @updatedAt
  usuario                 Usuario                @relation("DistribucionDetalleUsuario", fields: [usuarioId], references: [id], onDelete: Cascade)
  distribucion            DistribucionUtilidades @relation(fields: [distribucionId], references: [id])

  @@index([usuarioId])
  @@map("distribucion_detalles")
}

model Usuario {
  id        Int      @id @default(autoincrement())
  negocioId Int      // Usuario pertenece a un negocio
  email     String   @unique
  password  String
  nombre    String
  activo    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Campos migrados de Persona (para consolidaciÃ³n)
  rolId              Int?    // FK opcional a Rol (rol de negocio)
  participacionPorc  Float   @default(0) // % de participaciÃ³n en utilidades
  horasTotales       Int     @default(0) // Total horas trabajadas
  aportesTotales     Float   @default(0) // Total aportes econÃ³micos
  valorHora          Float   @default(0) // Valor por hora actual
  inversionHoras     Float   @default(0) // InversiÃ³n por horas
  inversionTotal     Float   @default(0) // InversiÃ³n total
  notas              String? // Notas adicionales

  // Campos para sistema SMTP (activaciÃ³n y recuperaciÃ³n)
  emailVerified        Boolean   @default(false)  // Si el email fue verificado
  activationToken      String?                    // Token de activaciÃ³n de cuenta
  resetPasswordToken   String?                    // Token de recuperaciÃ³n de contraseÃ±a
  resetPasswordExpires DateTime?                  // ExpiraciÃ³n del token de reset

  // Sistema de seguridad dinÃ¡mico
  securityRoleId       Int                        // FK al rol de seguridad dinÃ¡mico
  failedLoginAttempts  Int       @default(0)      // Intentos fallidos de login
  lockedUntil          DateTime?                  // Bloqueado hasta esta fecha
  lastPasswordChange   DateTime?                  // Ãšltimo cambio de contraseÃ±a
  mustChangePassword   Boolean   @default(false)  // Debe cambiar contraseÃ±a

  // RelaciÃ³n con negocio
  negocio       Negocio   @relation(fields: [negocioId], references: [id])
  rolNegocio    Rol?      @relation("UsuarioRolNegocio", fields: [rolId], references: [id])

  // Sistema de seguridad
  securityRole         SecurityRole      @relation(fields: [securityRoleId], references: [id])
  securityAuditLogs    SecurityAuditLog[]
  securitySessions     SecuritySession[]

  // Relaciones inversas (propiedad)
  categorias    Categoria[]
  campanas      Campana[]
  transacciones Transaccion[]

  // Relaciones con otras entidades
  registroHoras       RegistroHoras[]       @relation("RegistroHorasUsuario")
  valorHoras          ValorHora[]           @relation("ValorHoraUsuario")
  distribucionDetalle DistribucionDetalle[] @relation("DistribucionDetalleUsuario")

  // Sistema de Deuda de Horas
  hourDebts          HourDebt[]        @relation("HourDebtUsuario")
  createdDebts       HourDebt[]        @relation("HourDebtCreator")
  editedDebts        HourDebt[]        @relation("HourDebtEditor")
  deletedDebts       HourDebt[]        @relation("HourDebtDeleter")
  auditLogs          HourDebtAuditLog[]
  reportedBugReports BugReport[]       @relation("BugReportReporter")
  resolvedBugReports BugReport[]       @relation("BugReportResolver")

  // Roles de plataforma (opcional)
  rolesSistema  UsuarioRol[]

  @@index([negocioId])
  @@index([rolId])
  @@index([activationToken])
  @@index([resetPasswordToken])
  @@index([securityRoleId])
  @@index([lockedUntil])
  @@map("usuarios")
}

// Modelos para VS CategorÃ­as - Sistema Avanzado
model VSCarpeta {
  id          Int       @id @default(autoincrement())
  negocioId   Int
  nombre      String
  color       String
  visible     Boolean   @default(true)
  orden       Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  negocio     Negocio   @relation(fields: [negocioId], references: [id])
  grupos      VSGrupo[]

  @@index([negocioId])
  @@map("vs_carpetas")
}

model VSGrupo {
  id          Int       @id @default(autoincrement())
  negocioId   Int
  nombre      String
  color       String
  visible     Boolean   @default(true)
  orden       Int       @default(0)
  carpetaId   Int?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  negocio     Negocio   @relation(fields: [negocioId], references: [id])
  carpeta     VSCarpeta? @relation(fields: [carpetaId], references: [id])
  categorias  VSGrupoCategoria[]

  @@index([negocioId])
  @@map("vs_grupos")
}

model VSGrupoCategoria {
  id          Int       @id @default(autoincrement())
  grupoId     Int
  categoriaId Int
  createdAt   DateTime  @default(now())
  grupo       VSGrupo   @relation(fields: [grupoId], references: [id])
  categoria   Categoria @relation(fields: [categoriaId], references: [id])

  @@unique([grupoId, categoriaId])
  @@map("vs_grupo_categorias")
}

model VSConfiguracion {
  id                    Int      @id @default(autoincrement())
  negocioId             Int
  nombre                String
  configuracion         Json     // Almacena toda la configuraciÃ³n como JSON
  activo                Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  negocio               Negocio  @relation(fields: [negocioId], references: [id])

  @@unique([negocioId, nombre])
  @@index([negocioId])
  @@map("vs_configuraciones")
}

// ==========================
// Roles de plataforma (Auth)
// ==========================

model RolSistema {
  id          Int          @id @default(autoincrement())
  nombre      String       @unique
  descripcion String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  usuarios    UsuarioRol[]

  @@map("roles_sistema")
}

model UsuarioRol {
  usuarioId    Int
  rolSistemaId Int
  createdAt    DateTime @default(now())
  usuario      Usuario   @relation(fields: [usuarioId], references: [id])
  rolSistema   RolSistema @relation(fields: [rolSistemaId], references: [id])

  @@id([usuarioId, rolSistemaId])
  @@map("usuarios_roles")
}

// ==========================
// Sistema de Deuda de Horas
// ==========================

enum DebtStatus {
  ACTIVE
  FULLY_PAID
  CANCELLED
}

enum DebtDeletionReason {
  RECORD_REJECTED
  RECORD_DELETED
  HOURS_EDITED
  ADMIN_CORRECTION
}

enum AuditAction {
  CREATE
  UPDATE
  CANCEL
  DELETE
  REACTIVATE
}

enum RecordSource {
  MANUAL
  TIMER
}

enum TimerStatus {
  RUNNING
  PAUSED
  STOPPED
}

enum BugReportStatus {
  OPEN
  RESOLVED
}

model BugReport {
  id          Int             @id @default(autoincrement())
  negocioId   Int             @map("negocio_id")
  reporterId  Int             @map("reporter_id")
  moduleUrl   String          @map("module_url")
  evidenceUrl String?         @map("evidence_url")
  description String
  status      BugReportStatus @default(OPEN)
  resolvedAt  DateTime?       @map("resolved_at")
  resolvedById Int?           @map("resolved_by_id")
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  negocio     Negocio         @relation(fields: [negocioId], references: [id])
  reporter    Usuario         @relation("BugReportReporter", fields: [reporterId], references: [id])
  resolvedBy  Usuario?        @relation("BugReportResolver", fields: [resolvedById], references: [id])

  @@index([negocioId])
  @@index([negocioId, status])
  @@index([negocioId, createdAt])
  @@index([reporterId])
  @@map("bug_reports")
}

model HourDebt {
  id                Int       @id @default(autoincrement())
  negocioId         Int       @map("negocio_id")
  usuarioId         Int       @map("usuario_id")

  date              DateTime  @db.Date
  minutesOwed       Int       @map("minutes_owed")
  remainingMinutes  Int       @map("remaining_minutes")
  reason            String?
  status            DebtStatus @default(ACTIVE)

  createdById       Int       @map("created_by_id")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  editedById        Int?      @map("edited_by_id")
  editedAt          DateTime? @map("edited_at")
  deletedById       Int?      @map("deleted_by_id")
  deletedAt         DateTime? @map("deleted_at")

  negocio           Negocio             @relation(fields: [negocioId], references: [id])
  usuario           Usuario             @relation("HourDebtUsuario", fields: [usuarioId], references: [id])
  createdBy         Usuario             @relation("HourDebtCreator", fields: [createdById], references: [id])
  editedBy          Usuario?            @relation("HourDebtEditor", fields: [editedById], references: [id])
  deletedBy         Usuario?            @relation("HourDebtDeleter", fields: [deletedById], references: [id])
  deductions        DebtDeduction[]
  auditLogs         HourDebtAuditLog[]

  @@index([negocioId])
  @@index([negocioId, usuarioId])
  @@index([negocioId, status])
  @@index([usuarioId, date])
  @@map("hour_debts")
}

model DebtDeduction {
  id                   Int             @id @default(autoincrement())
  debtId               Int             @map("debt_id")
  registroHorasId      Int             @map("registro_horas_id")

  minutesDeducted      Int             @map("minutes_deducted")
  excessMinutes        Int             @default(0) @map("excess_minutes")

  deductedAt           DateTime        @default(now()) @map("deducted_at")

  deletedAt            DateTime?       @map("deleted_at")
  deletedReason        DebtDeletionReason? @map("deleted_reason")

  debt                 HourDebt        @relation(fields: [debtId], references: [id])
  registroHoras        RegistroHoras   @relation(fields: [registroHorasId], references: [id], onDelete: Restrict)

  @@unique([registroHorasId, debtId])
  @@index([debtId])
  @@index([registroHorasId])
  @@index([deletedAt])
  @@map("debt_deductions")
}

model HourDebtAuditLog {
  id              Int       @id @default(autoincrement())
  debtId          Int       @map("debt_id")
  action          AuditAction

  beforeState     Json?     @map("before_state")
  afterState      Json      @map("after_state")
  changedFields   String[]  @map("changed_fields")
  adminReason     String?   @map("admin_reason")

  performedBy     Int       @map("performed_by")
  performedAt     DateTime  @default(now()) @map("performed_at")
  ipAddress       String?   @map("ip_address")
  userAgent       String?   @map("user_agent")

  debt            HourDebt  @relation(fields: [debtId], references: [id])
  performedByUser Usuario   @relation(fields: [performedBy], references: [id])

  @@index([debtId])
  @@index([performedAt])
  @@index([action])
  @@map("hour_debt_audit_log")
}

// ==========================
// SISTEMA DE SEGURIDAD DINÃMICO
// ==========================

// Roles de seguridad configurables por negocio
model SecurityRole {
  id          Int       @id @default(autoincrement())
  negocioId   Int       @map("negocio_id")
  name        String    // "Contador", "Supervisor", etc.
  description String?
  color       String?   // Color para UI (hex)
  isSystem    Boolean   @default(false) @map("is_system") // true = no editable (ADMIN, etc.)
  priority    Int       @default(0) // Mayor = mÃ¡s importante
  active      Boolean   @default(true)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  negocio     Negocio   @relation(fields: [negocioId], references: [id])
  permissions RolePermission[]
  users       Usuario[]

  @@unique([negocioId, name])
  @@index([negocioId])
  @@index([negocioId, active])
  @@map("security_roles")
}

// CatÃ¡logo de permisos disponibles (global, no por negocio)
model Permission {
  id           Int       @id @default(autoincrement())
  code         String    @unique // RESOURCE.CONTEXT.ACTION
  resource     String    // RESOURCE
  context      String    // CONTEXT
  subject      String    // "Usuario", "RegistroHoras", "Transaccion", etc.
  action       String    // "create", "read", "update", "delete", "approve", "manage"
  description  String    // DescripciÃ³n legible
  category     String    // "users", "hours", "finance", "security", "settings"
  route        String?   // Ruta principal asociada al permiso
  dependencies Json?     // Codigos de permisos requeridos/recomendados
  isSystem     Boolean   @default(true) @map("is_system")
  active       Boolean   @default(true)
  displayOrder Int       @default(0) @map("display_order") // Orden en UI

  rolePermissions RolePermission[]

  @@unique([subject, action])
  @@index([category])
  @@map("permissions")
}

// Permisos asignados a cada rol
model RolePermission {
  id           Int       @id @default(autoincrement())
  roleId       Int       @map("role_id")
  permissionId Int       @map("permission_id")
  conditions   Json?     // Condiciones CASL: { "usuarioId": "own" } para permisos sobre propios recursos
  createdAt    DateTime  @default(now()) @map("created_at")

  role         SecurityRole @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission   @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
  @@map("role_permissions")
}

// Log de auditorÃ­a de seguridad
model SecurityAuditLog {
  id          Int       @id @default(autoincrement())
  negocioId   Int       @map("negocio_id")
  userId      Int?      @map("user_id")       // null para intentos fallidos
  eventType   String    @map("event_type")    // LOGIN, LOGOUT, LOGIN_FAILED, PASSWORD_CHANGE, ROLE_ASSIGNED, etc.
  targetType  String?   @map("target_type")   // "Usuario", "SecurityRole", etc.
  targetId    Int?      @map("target_id")     // ID del recurso afectado
  description String                           // DescripciÃ³n legible del evento
  metadata    Json?                            // Datos adicionales (cambios, valores anteriores, etc.)
  ipAddress   String?   @map("ip_address")
  userAgent   String?   @map("user_agent")
  createdAt   DateTime  @default(now()) @map("created_at")

  negocio     Negocio   @relation(fields: [negocioId], references: [id])
  user        Usuario?  @relation(fields: [userId], references: [id])

  @@index([negocioId, createdAt])
  @@index([negocioId, eventType])
  @@index([negocioId, userId])
  @@index([userId, createdAt])
  @@map("security_audit_logs")
}

// Sesiones activas de usuarios
model SecuritySession {
  id           String    @id @default(uuid())
  userId       Int       @map("user_id")
  negocioId    Int       @map("negocio_id")
  tokenHash    String    @unique @map("token_hash") // Hash del JWT para invalidaciÃ³n
  deviceInfo   String?   @map("device_info")        // InformaciÃ³n del dispositivo
  ipAddress    String?   @map("ip_address")
  lastActivity DateTime  @default(now()) @map("last_activity")
  expiresAt    DateTime  @map("expires_at")
  isActive     Boolean   @default(true) @map("is_active")
  createdAt    DateTime  @default(now()) @map("created_at")

  user         Usuario   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, isActive])
  @@index([expiresAt])
  @@index([negocioId])
  @@map("security_sessions")
}

// ConfiguraciÃ³n de seguridad por negocio
model SecuritySettings {
  id                      Int      @id @default(autoincrement())
  negocioId               Int      @unique @map("negocio_id")

  // PolÃ­ticas de contraseÃ±a
  minPasswordLength       Int      @default(8)  @map("min_password_length")
  requireUppercase        Boolean  @default(true) @map("require_uppercase")
  requireNumbers          Boolean  @default(true) @map("require_numbers")
  requireSpecialChars     Boolean  @default(false) @map("require_special_chars")
  passwordExpirationDays  Int      @default(0) @map("password_expiration_days") // 0 = no expira

  // PolÃ­ticas de sesiÃ³n
  sessionTimeoutMinutes   Int      @default(480) @map("session_timeout_minutes") // 8 horas
  maxConcurrentSessions   Int      @default(5) @map("max_concurrent_sessions")

  // PolÃ­ticas de bloqueo
  maxLoginAttempts        Int      @default(5) @map("max_login_attempts")
  lockoutDurationMinutes  Int      @default(15) @map("lockout_duration_minutes")

  // AuditorÃ­a
  auditRetentionDays      Int      @default(365) @map("audit_retention_days")
  logAllActions           Boolean  @default(true) @map("log_all_actions")

  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")

  negocio                 Negocio  @relation(fields: [negocioId], references: [id])

  @@map("security_settings")
}

