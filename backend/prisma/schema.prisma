generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================
// MODELO NEGOCIO (Multi-Tenant)
// ==========================

model Negocio {
  id                       Int                      @id @default(autoincrement())
  nombre                   String
  descripcion              String?
  activo                   Boolean                  @default(true)
  configuracion            Json?                    // Configuración específica del negocio
  createdAt                DateTime                 @default(now())
  updatedAt                DateTime                 @updatedAt

  // Relaciones
  usuarios                 Usuario[]
  personas                 Persona[]
  valorHoras               ValorHora[]
  registroHoras            RegistroHoras[]
  categorias               Categoria[]
  campanas                 Campana[]
  transacciones            Transaccion[]
  distribucionUtilidades   DistribucionUtilidades[]
  vsCarpetas               VSCarpeta[]
  vsGrupos                 VSGrupo[]
  vsConfiguraciones        VSConfiguracion[]

  @@map("negocios")
}

model Rol {
  id          Int         @id @default(autoincrement())
  nombreRol   String      @unique
  importancia Int         @default(0)
  descripcion String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  personas    Persona[]
  valorHoras  ValorHora[]
  usuarios    Usuario[]   @relation("UsuarioRolNegocio") // Nueva relación con Usuario

  @@map("roles")
}

model Persona {
  id                  Int                   @id @default(autoincrement())
  negocioId           Int
  nombre              String
  rolId               Int
  usuarioId           Int?
  horasTotales        Int                   @default(0)
  aportesTotales      Float                 @default(0)
  valorHora           Float                 @default(0)
  inversionHoras      Float                 @default(0)
  inversionTotal      Float                 @default(0)
  participacionPorc   Float                 @default(0)
  notas               String?
  activo              Boolean               @default(true)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  email               String?
  distribucionDetalle DistribucionDetalle[]
  negocio             Negocio               @relation(fields: [negocioId], references: [id])
  rol                 Rol                   @relation(fields: [rolId], references: [id])
  registroHoras       RegistroHoras[]
  transacciones       Transaccion[]
  valorHoras          ValorHora[]
  usuario             Usuario?              @relation(fields: [usuarioId], references: [id])

  @@unique([negocioId, nombre])
  @@index([negocioId])
  @@map("personas")
}

model ValorHora {
  id          Int       @id @default(autoincrement())
  negocioId   Int
  personaId   Int       // Deprecado - usar usuarioId
  usuarioId   Int?      // Nueva FK a Usuario
  rolId       Int
  valor       Float
  notas       String?
  fechaInicio DateTime  @default(now())
  fechaFin    DateTime?
  activo      Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  negocio     Negocio   @relation(fields: [negocioId], references: [id])
  rol         Rol       @relation(fields: [rolId], references: [id])
  persona     Persona   @relation(fields: [personaId], references: [id])
  usuario     Usuario?  @relation("ValorHoraUsuario", fields: [usuarioId], references: [id], onDelete: Cascade)

  @@index([negocioId])
  @@index([usuarioId])
  @@map("valor_horas")
}

model RegistroHoras {
  id             Int       @id @default(autoincrement())
  negocioId      Int
  personaId      Int       // Deprecado - usar usuarioId
  usuarioId      Int?      // Nueva FK a Usuario
  campanaId      Int?
  fecha          DateTime
  horas          Float
  descripcion    String?
  aprobado       Boolean   @default(false)
  aprobadoPor    Int?      // ID del usuario que aprobó
  fechaAprobacion DateTime? // Cuándo fue aprobado
  rechazado      Boolean   @default(false)
  motivoRechazo  String?
  origen         String    @default("MANUAL") // MANUAL o TIMER
  timerInicio    DateTime? // Para registros desde timer
  timerFin       DateTime? // Para registros desde timer
  estado         String?   // RUNNING, PAUSADO, COMPLETADO (solo para TIMER)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  negocio        Negocio   @relation(fields: [negocioId], references: [id])
  campana        Campana?  @relation(fields: [campanaId], references: [id])
  persona        Persona   @relation(fields: [personaId], references: [id])
  usuario        Usuario?  @relation("RegistroHorasUsuario", fields: [usuarioId], references: [id], onDelete: Cascade)

  @@index([negocioId])
  @@index([negocioId, personaId])
  @@index([negocioId, usuarioId])
  @@index([negocioId, aprobado])
  @@map("registro_horas")
}

model Categoria {
  id            Int           @id @default(autoincrement())
  negocioId     Int
  nombre        String
  usuarioId     Int?
  descripcion   String?
  color         String?
  activo        Boolean       @default(true)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  negocio       Negocio       @relation(fields: [negocioId], references: [id])
  transacciones Transaccion[]
  vsGrupoCategorias VSGrupoCategoria[]
  usuario       Usuario?      @relation(fields: [usuarioId], references: [id])

  @@unique([negocioId, nombre])
  @@index([negocioId])
  @@map("categorias")
}

model Campana {
  id            Int             @id @default(autoincrement())
  negocioId     Int
  nombre        String
  usuarioId     Int?
  descripcion   String?
  fechaInicio   DateTime
  fechaFin      DateTime?
  presupuesto   Float?
  ingresoTotal  Float           @default(0)
  gastoTotal    Float           @default(0)
  utilidad      Float           @default(0)
  activo        Boolean         @default(true)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  negocio       Negocio         @relation(fields: [negocioId], references: [id])
  registroHoras RegistroHoras[]
  transacciones Transaccion[]
  usuario       Usuario?        @relation(fields: [usuarioId], references: [id])

  @@unique([negocioId, nombre])
  @@index([negocioId])
  @@map("campanas")
}

model TipoTransaccion {
  id            Int           @id @default(autoincrement())
  nombre        String        @unique
  descripcion   String?
  activo        Boolean       @default(true)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  transacciones Transaccion[]

  @@map("tipos_transaccion")
}

model Transaccion {
  id          Int             @id @default(autoincrement())
  negocioId   Int
  tipoId      Int
  usuarioId   Int?
  monto       Float
  concepto    String
  fecha       DateTime
  categoriaId Int?
  personaId   Int?
  campanaId   Int?
  moneda      String          @default("COP")
  notas       String?
  comprobante String?
  aprobado    Boolean         @default(false)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  negocio     Negocio         @relation(fields: [negocioId], references: [id])
  campana     Campana?        @relation(fields: [campanaId], references: [id])
  persona     Persona?        @relation(fields: [personaId], references: [id])
  tipo        TipoTransaccion @relation(fields: [tipoId], references: [id])
  categoria   Categoria?      @relation(fields: [categoriaId], references: [id])
  usuario     Usuario?        @relation(fields: [usuarioId], references: [id])

  @@index([negocioId])
  @@index([negocioId, fecha])
  @@map("transacciones")
}

model DistribucionUtilidades {
  id            Int                   @id @default(autoincrement())
  negocioId     Int
  periodo       String
  fecha         DateTime              @default(now())
  utilidadTotal Float
  estado        String                @default("Pendiente")
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
  negocio       Negocio               @relation(fields: [negocioId], references: [id])
  detalles      DistribucionDetalle[]

  @@index([negocioId])
  @@map("distribucion_utilidades")
}

model DistribucionDetalle {
  id                      Int                    @id @default(autoincrement())
  distribucionId          Int
  personaId               Int                    // Deprecado - usar usuarioId
  usuarioId               Int?                   // Nueva FK a Usuario
  porcentajeParticipacion Float
  montoDistribuido        Float
  createdAt               DateTime               @default(now())
  updatedAt               DateTime               @updatedAt
  persona                 Persona                @relation(fields: [personaId], references: [id])
  usuario                 Usuario?               @relation("DistribucionDetalleUsuario", fields: [usuarioId], references: [id], onDelete: Cascade)
  distribucion            DistribucionUtilidades @relation(fields: [distribucionId], references: [id])

  @@index([usuarioId])
  @@map("distribucion_detalles")
}

model Usuario {
  id        Int      @id @default(autoincrement())
  negocioId Int      // Usuario pertenece a un negocio
  email     String   @unique
  password  String
  nombre    String
  rol       String   @default("USER") // ADMIN_NEGOCIO, USER, EMPLEADO
  activo    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Campos migrados de Persona (para consolidación)
  rolId              Int?    // FK opcional a Rol (rol de negocio)
  participacionPorc  Float   @default(0) // % de participación en utilidades
  horasTotales       Int     @default(0) // Total horas trabajadas
  aportesTotales     Float   @default(0) // Total aportes económicos
  valorHora          Float   @default(0) // Valor por hora actual
  inversionHoras     Float   @default(0) // Inversión por horas
  inversionTotal     Float   @default(0) // Inversión total
  notas              String? // Notas adicionales

  // Campos para sistema SMTP (activación y recuperación)
  emailVerified        Boolean   @default(false)  // Si el email fue verificado
  activationToken      String?                    // Token de activación de cuenta
  resetPasswordToken   String?                    // Token de recuperación de contraseña
  resetPasswordExpires DateTime?                  // Expiración del token de reset

  // Relación con negocio
  negocio       Negocio   @relation(fields: [negocioId], references: [id])
  rolNegocio    Rol?      @relation("UsuarioRolNegocio", fields: [rolId], references: [id])

  // Relaciones inversas (propiedad)
  personas      Persona[]
  categorias    Categoria[]
  campanas      Campana[]
  transacciones Transaccion[]

  // Relaciones migradas de Persona
  registroHoras       RegistroHoras[]       @relation("RegistroHorasUsuario")
  valorHoras          ValorHora[]           @relation("ValorHoraUsuario")
  distribucionDetalle DistribucionDetalle[] @relation("DistribucionDetalleUsuario")

  // Roles de plataforma (opcional)
  rolesSistema  UsuarioRol[]

  @@index([negocioId])
  @@index([negocioId, rol])
  @@index([rolId])
  @@index([activationToken])
  @@index([resetPasswordToken])
  @@map("usuarios")
}

// Modelos para VS Categorías - Sistema Avanzado
model VSCarpeta {
  id          Int       @id @default(autoincrement())
  negocioId   Int
  nombre      String
  color       String
  visible     Boolean   @default(true)
  orden       Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  negocio     Negocio   @relation(fields: [negocioId], references: [id])
  grupos      VSGrupo[]

  @@index([negocioId])
  @@map("vs_carpetas")
}

model VSGrupo {
  id          Int       @id @default(autoincrement())
  negocioId   Int
  nombre      String
  color       String
  visible     Boolean   @default(true)
  orden       Int       @default(0)
  carpetaId   Int?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  negocio     Negocio   @relation(fields: [negocioId], references: [id])
  carpeta     VSCarpeta? @relation(fields: [carpetaId], references: [id])
  categorias  VSGrupoCategoria[]

  @@index([negocioId])
  @@map("vs_grupos")
}

model VSGrupoCategoria {
  id          Int       @id @default(autoincrement())
  grupoId     Int
  categoriaId Int
  createdAt   DateTime  @default(now())
  grupo       VSGrupo   @relation(fields: [grupoId], references: [id])
  categoria   Categoria @relation(fields: [categoriaId], references: [id])

  @@unique([grupoId, categoriaId])
  @@map("vs_grupo_categorias")
}

model VSConfiguracion {
  id                    Int      @id @default(autoincrement())
  negocioId             Int
  nombre                String
  configuracion         Json     // Almacena toda la configuración como JSON
  activo                Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  negocio               Negocio  @relation(fields: [negocioId], references: [id])

  @@unique([negocioId, nombre])
  @@index([negocioId])
  @@map("vs_configuraciones")
}

// ==========================
// Roles de plataforma (Auth)
// ==========================

model RolSistema {
  id          Int          @id @default(autoincrement())
  nombre      String       @unique
  descripcion String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  usuarios    UsuarioRol[]

  @@map("roles_sistema")
}

model UsuarioRol {
  usuarioId    Int
  rolSistemaId Int
  createdAt    DateTime @default(now())
  usuario      Usuario   @relation(fields: [usuarioId], references: [id])
  rolSistema   RolSistema @relation(fields: [rolSistemaId], references: [id])

  @@id([usuarioId, rolSistemaId])
  @@map("usuarios_roles")
}
